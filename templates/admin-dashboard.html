<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Sistema Gestione CV</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="dashboard-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>CV Manager</h2>
                <span class="badge badge-primary">Admin</span>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/" class="nav-item">
                    <span>üè†</span> Home
                </a>
                <a href="/admin-dashboard" class="nav-item active">
                    <span>üìä</span> Dashboard
                </a>
                <a href="/logout" class="nav-item">
                    <span>üö™</span> Logout
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <p>Benvenuto, {{user_nome}} {{user_cognome}}</p>
            </div>
        </aside>
        
        <main class="main-content">
            <header class="dashboard-header">
                <h1>Dashboard Amministratore</h1>
                <p>Gestione completa degli studenti e dei curriculum</p>
            </header>
            
            <!-- Statistiche -->
            <section class="section stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-content">
                        <h3>Totale Studenti</h3>
                        <p class="stat-number">{{total_students}}</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üìÑ</div>
                    <div class="stat-content">
                        <h3>CV Caricati</h3>
                        <p class="stat-number">{{total_cvs}}</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üíº</div>
                    <div class="stat-content">
                        <h3>Esperienze Lavorative</h3>
                        <p class="stat-number">{{total_work_exp}}</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üéì</div>
                    <div class="stat-content">
                        <h3>Esperienze Formative</h3>
                        <p class="stat-number">{{total_edu_exp}}</p>
                    </div>
                </div>
            </section>
            
            <!-- Sezione Lista Studenti -->
            <section class="dashboard-section">
                <div class="section-header">
                    <h2>Studenti Registrati</h2>
                    <input type="text" id="searchInput" placeholder="Cerca studente..." class="form-control" style="max-width:280px;">
                </div>
                
                <div class="card">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Cognome</th>
                                    <th>Email</th>
                                    <th>Data Nascita</th>
                                    <th>CV</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                {{students_rows}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Modale Modifica Utente -->
    <div id="editUserModal" class="modal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,.5); align-items:center; justify-content:center; z-index:100;">
        <div class="modal-content card dark-card" style="max-width:520px; width:92%;">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="color: #fff; margin:0;">Modifica Studente</h3>
                <button class="close-btn" onclick="hideEditUserModal()" style="background:rgba(255,255,255,0.1); border:none; color:#fff; font-size:24px; width:32px; height:32px; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">√ó</button>
            </div>
            
            <form id="editUserForm" onsubmit="return submitEditUser(event);">
                <input type="hidden" id="edit_user_id" name="user_id">
                
                <div class="form-group">
                    <label for="edit_nome" style="color: #fff;">Nome:</label>
                    <input type="text" id="edit_nome" name="nome" required class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="edit_cognome" style="color: #fff;">Cognome:</label>
                    <input type="text" id="edit_cognome" name="cognome" required class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="edit_email" style="color: #fff;">Email:</label>
                    <input type="email" id="edit_email" name="email" required class="form-control">
                </div>
                
                <button type="submit" class="btn btn-primary">Salva Modifiche</button>
            </form>
        </div>
    </div>
    
    <script>
        // Funzionalit√† di ricerca
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const searchValue = this.value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchValue) ? '' : 'none';
            });
        });
        
        function editStudent(userId) {
            // Recupera i dati dello studente dalla riga della tabella
            const row = document.querySelector(`#studentsTableBody tr td:first-child`);
            const rows = document.querySelectorAll('#studentsTableBody tr');
            let studentData = null;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells[0] && cells[0].textContent == userId) {
                    studentData = {
                        id: cells[0].textContent,
                        nome: cells[1].textContent,
                        cognome: cells[2].textContent,
                        email: cells[3].textContent
                    };
                }
            });
            
            if (studentData) {
                document.getElementById('edit_user_id').value = studentData.id;
                document.getElementById('edit_nome').value = studentData.nome;
                document.getElementById('edit_cognome').value = studentData.cognome;
                document.getElementById('edit_email').value = studentData.email;
                document.getElementById('editUserModal').style.display = 'flex';
            }
        }
        
        function hideEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }
        
        function submitEditUser(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            fetch('/api/admin/update-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Errore: ' + result.error);
                }
            })
            .catch(error => {
                alert('Errore di connessione: ' + error);
            });
            
            return false;
        }
        
        function deleteStudent(userId, userName) {
            if (!confirm(`Sei sicuro di voler eliminare l'utente ${userName}? Questa azione non pu√≤ essere annullata.`)) {
                return;
            }
            
            fetch('/api/admin/delete-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Errore: ' + result.error);
                }
            })
            .catch(error => {
                alert('Errore di connessione: ' + error);
            });
        }
        
        // Rimosso modale Aggiungi Utente su richiesta
    </script>
</body>
</html>
